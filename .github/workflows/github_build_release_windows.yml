name: Build Release Windows
on:
  push:
    branches:
      - release
      - pre-release
  pull_request:
    branches:
      - release
      - pre-release
#    tags:
#      - "v*.*.*"

env:
  go-version: "^1.16.4"
  go-stable: "true"
  artifact-retention-days: 5

jobs:
  build-and-publish:
    name: Build & Publish (Pre)Release Windows
    runs-on: windows-latest
    if: ${{ !contains(github.event.head_commit.message, '[Skip CI]') }}
    steps:
      # æ‹‰å–é¡¹ç›®ä»£ç 
      - name: Checkout ğŸ”€
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0

      # è·å–Gitä¿¡æ¯
      - name: Get Git Info ğŸ’¡
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\1_get_info.ps1

      # é…ç½®æ„å»ºä¿¡æ¯
      - name: Configurate Build Information ğŸ–¨
        if: success()
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\2_configuration.ps1

      # æ„å»ºå‰æ£€æŸ¥
      - name: Check on Failures âŒ
        if: success()
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\3_checks.ps1

      # é…ç½®Golangç¯å¢ƒ
      - name: Setup Go Environment ğŸ“
        uses: actions/setup-go@v2
        if: success()
        with:
          go-version: ${{ env.go-version }}
          stable: ${{ env.go-stable }}

      # è·å–ä¾èµ–åŒ…
      - name: Get Go Modules ğŸ“Ÿ
        if: success()
        shell: pwsh
        run: |
          go version
          go env
          go get github.com/josephspurrier/goversioninfo/cmd/goversioninfo
          go generate -x -v .\main.go
          mkdir -p ${env:BUILD_PATH}

      # è¿è¡ŒGolangæµ‹è¯•
      #  - name: Golang Test âœ…
      #      run: |

      # æ„å»º64ä½åº”ç”¨
      - name: Build x64 Application ğŸ› 
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="amd64"
          go build -ldflags "-H=windowsgui -s -w" -o ${env:BUILD_PATH}\Clash.Mini_x64.exe

      # æ„å»º32ä½åº”ç”¨
      - name: Build x86 Application ğŸ› 
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="386"
          go build -a -v -x -ldflags "-H=windowsgui -s -w" -o ${env:BUILD_PATH}\Clash.Mini_x86.exe

      # å‡†å¤‡å‘å¸ƒPreReleaseæ–‡ä»¶
      - id: prepare-pre-release
        name: Prepare to Publish PreRelease ğŸ•¹
        if: ${{ env.GIT_BRANCH != 'release' && success() }}
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\4_prepare_pre.ps1

      # ä¸Šä¼ 64ä½åº”ç”¨åˆ°Actions Artifacts
      - name: Upload x64 Application to Artifacts ğŸ“¤
        if: ${{ steps.prepare-pre-release.outcome == 'success' }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X64_FILENAME }}
          path: ${{ env.PUBLISH_PATH }}\*_x64.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}

      # ä¸Šä¼ 32ä½åº”ç”¨åˆ°Actions Artifacts
      - name: Upload x86 Application to Artifacts ğŸ“¤
        if: ${{ steps.prepare-pre-release.outcome == 'success' && success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X86_FILENAME }}
          path: ${{ env.PUBLISH_PATH }}\*_x86.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}

      # å‡†å¤‡å‘å¸ƒReleaseæ–‡ä»¶
      - name: Prepare to Publish Release ğŸ•¹
        if: ${{ env.GIT_BRANCH == 'release' && success() }}
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\5_prepare_release.ps1

      # å‡†å¤‡å‹ç¼©
      - name: Prepare to Compression ğŸ•¹
        if: success()
        shell: pwsh
        run: pwsh -f .\.github\scripts\steps\publish\6_prepare_compress.ps1

      # å‹ç¼©æ‰“åŒ…
      - name: Compression x64 ğŸ“¦
        if: success()
        shell: pwsh
        run: |
          7z a -t7z -mx=9 ${env:RELEASE_PKG_X64} ${env:PUBLISH_PATH_X64}\*
          7z a -t7z -mx=9 ${env:RELEASE_PKG_X86} ${env:PUBLISH_PATH_X86}\*
          ls $env:RELEASE_PATH

      # ç”ŸæˆRelease Hash
      - name: Hash Releases âŒ¨
        if: success()
        shell: pwsh
        run: |
          echo (Get-FileHash ${env:RELEASE_PKG_X64} -Algorithm SHA256).Hash > "${env:RELEASE_PKG_X64}.sha256"
          echo (Get-FileHash ${env:RELEASE_PKG_X86} -Algorithm SHA256).Hash > "${env:RELEASE_PKG_X86}.sha256"
          ls $env:RELEASE_PATH

      # å‘å¸ƒåˆ°Releases
      - name: Publish to Releases ğŸ’¸
        if: success()
        uses: ncipollo/release-action@v1
        with:
          prerelease: ${{ env.GIT_BRANCH != 'release' }}
          tag: ${{ env.GIT_TAG }}
          artifacts: ${{ env.RELEASE_PATH }}\Clash.Mini*
          #          bodyFile: .\CHANGELOG.md
          bodyFile: .\RELEASELOG.md
          token: ${{ secrets.ACTION_ACCESS_TOKEN }}

  notifaction:
    name: Notification
    runs-on: ubuntu-latest
    needs: build-release-windows
    env:
      CHAT_ID: ${{ secrets.CHAT_ID }}
    steps:
      # æ‹‰å–é¡¹ç›®ä»£ç 
      - name: Checkout ğŸ”€
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 1

      # æ¨é€åˆ°TG
      - name: Push to TG ğŸ“°
        if: success()
        shell: bash
        run: bash ./.github/scripts/steps/notification/1_push_tg.sh
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          GIT_TAG: ${{ needs.build-release-windows.outputs.git-tag }}
          RELEASE_PKG_X64: ${{ needs.build-release-windows.outputs.release-pkg-x64 }}
          RELEASE_PKG_X86: ${{ needs.build-release-windows.outputs.release-pkg-x86 }}
