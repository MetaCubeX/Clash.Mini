name: Dev Windows
on:
  push:
    branches:
      - canary
  pull_request:
    branches:
      - canary

env:
  go-version: "^1.16.4"
  go-stable: "true"
  artifact-retention-days: 5

jobs:
  build-dev-windows:
    name: Build Dev Windows
    runs-on: windows-latest
    if: ${{ !contains(github.event.head_commit.message, '[Skip CI]') }}
    steps:
      # ÊãâÂèñÈ°πÁõÆ‰ª£Á†Å
      - name: Checkout üîÄ
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          fetch-depth: 0

      # Ëé∑ÂèñGit‰ø°ÊÅØ
      - name: Get Git Info üí°
        shell: pwsh
        run: |
          $VERSION_REGEXP="^v?\d+\.\d+\.\d+(\.\d+)?(-pre)?$"
          $VERSION_RELEASE_REGEXP="^v?\d+\.\d+\.\d+(\.\d+)?$"
          $VERSION_PRE_REGEXP="^v?\d+\.\d+\.\d+(\.\d+)?-pre$"
          echo "VERSION_REGEXP=$VERSION_REGEXP" >> $env:GITHUB_ENV
          echo "VERSION_RELEASE_REGEXP=$VERSION_RELEASE_REGEXP" >> $env:GITHUB_ENV
          echo "VERSION_PRE_REGEXP=$VERSION_PRE_REGEXP" >> $env:GITHUB_ENV
          $GIT_BRANCH=$env:GITHUB_REF -replace "refs/heads/", ""
          echo "GIT_BRANCH=$GIT_BRANCH" >> $env:GITHUB_ENV
          echo "Current Branch: $GIT_BRANCH"

          $SHORT_SHA=${env:GITHUB_SHA}.Substring(0,7)
          echo "SHORT_SHA=$SHORT_SHA" >> $env:GITHUB_ENV
          echo "Current commit hash id: ${env:GITHUB_SHA} ($SHORT_SHA)"

          $GIT_TAG_RELEASE_VERSION=git tag -l | where { $_ -match $VERSION_RELEASE_REGEXP } | sort -descending -top 1
          $GIT_TAG_PRE_VERSION=git tag -l | where { $_ -match $VERSION_PRE_REGEXP } | sort -descending -top 1
          if ($GIT_TAG_PRE_VERSION -eq $GIT_TAG_RELEASE_VERSION + "-pre") { $GIT_TAG_LATEST=$GIT_TAG_RELEASE_VERSION }
            else { $GIT_TAG_LATEST=@($GIT_TAG_RELEASE_VERSION, $GIT_TAG_PRE_VERSION) | sort -descending -top 1 }
          echo "GIT_TAG_LATEST=$GIT_TAG_LATEST" >> $env:GITHUB_ENV
          echo "Latest Tag: $GIT_TAG_LATEST"

      # ÈÖçÁΩÆÊûÑÂª∫‰ø°ÊÅØ
      - name: Configurate Build Information üñ®
        if: success()
        shell: pwsh
        run: |
          $BUILD_PATH="$pwd\build"
          $PUBLISH_PATH="$BUILD_PATH\publish"
          echo "BUILD_PATH=$BUILD_PATH" >> $env:GITHUB_ENV
          echo "PUBLISH_PATH=$PUBLISH_PATH" >> $env:GITHUB_ENV

          $BUILD_VERSION=(cat .\versioninfo.json | jq -r ".StringFileInfo.ProductVersion")
          echo "BUILD_VERSION=$BUILD_VERSION" >> $env:GITHUB_ENV
          echo "Build Version: v$BUILD_VERSION"
          $GIT_TAG="v$BUILD_VERSION$(${env:GIT_BRANCH} -ne 'release' ? '-pre' : '')"
          echo "GIT_TAG=$GIT_TAG" >> $env:GITHUB_ENV
          echo "Current Tag: $GIT_TAG"

      #      # ÊûÑÂª∫ÂâçÊ£ÄÊü•
      #      - name: Check on Failures ‚ùå
      #        if: success()
      #        shell: pwsh
      #        run: |

      # ÈÖçÁΩÆGolangÁéØÂ¢É
      - name: Setup Go Environment üìç
        uses: actions/setup-go@v2
        if: success()
        with:
          go-version: ${{ env.go-version }}
          stable: ${{ env.go-stable }}

      # Ëé∑Âèñ‰æùËµñÂåÖ
      - name: Get Go Modules üìü
        if: success()
        shell: pwsh
        run: |
          go version
          go env
          go get github.com/josephspurrier/goversioninfo/cmd/goversioninfo
          go get github.com/go-bindata/go-bindata/v3/go-bindata@v3.1.3
          go mod vendor -v
          go generate -x -v .\main.go
          go generate -x -v .\static\handler.go
          mkdir -p ${env:BUILD_PATH}

      # ËøêË°åGolangÊµãËØï
      #  - name: Golang Test ‚úÖ
      #      run: |

      # ÊûÑÂª∫64‰ΩçÂ∫îÁî®
      - name: Build x64 Application üõ†
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="amd64"
          go build -ldflags "-H=windowsgui -s -w" -o ${env:BUILD_PATH}\Clash.Mini_dev_x64.exe

      # ÊûÑÂª∫32‰ΩçÂ∫îÁî®
      - name: Build x86 Application üõ†
        if: success()
        shell: pwsh
        run: |
          $env:GOOS="windows"
          $env:GOARCH="386"
          go build -a -v -x -ldflags "-H=windowsgui -s -w" -o ${env:BUILD_PATH}\Clash.Mini_dev_x86.exe

      # ÂáÜÂ§á‰∏ä‰º†ArtifactÊñá‰ª∂
      - name: Prepare to Upload üïπ
        if: success()
        shell: pwsh
        run: |
          cd $env:BUILD_PATH
          mkdir -p $env:PUBLISH_PATH
          $BUILD_X64_FILENAME="Clash.Mini_${env:GIT_BRANCH}_v${env:BUILD_VERSION}_${env:SHORT_SHA}_x64.exe"
          $BUILD_X86_FILENAME="Clash.Mini_${env:GIT_BRANCH}_v${env:BUILD_VERSION}_${env:SHORT_SHA}_x86.exe"
          echo "BUILD_X64_FILENAME=$BUILD_X64_FILENAME" >> $env:GITHUB_ENV
          echo "BUILD_X86_FILENAME=$BUILD_X86_FILENAME" >> $env:GITHUB_ENV
          cp .\Clash.Mini_dev_*.exe $env:PUBLISH_PATH\
          echo "Ready to upload the following file(s):"
          ls $env:PUBLISH_PATH

      # ‰∏ä‰º†64‰ΩçÂ∫îÁî®Âà∞Actions Artifacts
      - name: Upload x64 Application to Artifacts üì§
        if: success()
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X64_FILENAME }}
          path: ${{ env.PUBLISH_PATH }}\*_x64.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}

      # ‰∏ä‰º†32‰ΩçÂ∫îÁî®Âà∞Actions Artifacts
      - name: Upload x86 Application to Artifacts üì§
        if: success()
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.BUILD_X86_FILENAME }}
          path: ${{ env.PUBLISH_PATH }}\*_x86.exe
          if-no-files-found: error
          retention-days: ${{ env.artifact-retention-days }}
